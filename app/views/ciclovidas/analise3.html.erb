<div class="right_col" role="main">
  <div class="">
    <div class="page-title">
      <div class="title_left">
        <h3>Painel de análises sobre os barris da <%= current_user.cliente.nome_cervejaria %></h3>
      </div>
    </div>
    <!-- gráfico de barras com as quantidades de uso de cara barril no total -->
    <div class="col-md-12 col-sm-12 col-xs-12">
      <div class="x_panel">
        <div class="row">
            <div class="x_title">
              <h2>Quantidade de uso de cada barril</h2>
              <div class="clearfix"></div>
            </div>
            <div class="x_content" >
              <canvas id="usostotalChart"></canvas>
            </div>
        </div>
        <div class="clearfix"></div> 
      </div>
    </div>
    <% array_itens = [] %>
    <% array_itensid = [] %>
      <% @ciclovida_itens.each do |ciclovida| %>
        <% array_itensid << ciclovida.item_id %>
        <% array_itens << ciclovida.item.item_name %>
      <% end %>
    <div class="col-md-12 col-sm-12 col-xs-12">
      <div class="x_panel">
        <div class="row">
            <div class="x_title">
              <h2>Informações dos barris</h2>
              <div class="clearfix"></div>
            </div>
            <!-- tabela com quantidade de uso de cada barril -->
            <div class="col-md-6 col-sm-6 col-xs-12">
            <div class="x_panel">
              <div class="x_title">
                <h2>Variação do estoque por mês</h2>
                <div class="clearfix"></div>
              </div>
                <div class="x_content" >
                  <table id="datatable-responsive2" class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%">
                    <thead>
                      <tr>
                        <th>Id do item</th>
                        <th>Item</th>
                        <th>Localização do produto</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% array_itensid.each do |itensid| %>
                          <tr>
                            <td><%= itensid %></td>
                            <td><%= Item.where(cliente_id: current_user.cliente_id, id: itensid).take.item_name %></td>
                            <% usos = (@ciclovida.where(item_id: itensid).count - @ciclovida.where(item_id: itensid, localizacao: "Estoque final. Sujo e vazio").count - @ciclovida.where(item_id: itensid, localizacao: "Câmara fria. Cheio").count - @ciclovida.where(item_id: itensid, localizacao: "Estoque de barris. Limpo e vazio").count ) %>
                            <% if usos == nil %>
                                <% usos = 0 %>
                                 <td><%= usos %></td>
                            <% else %>
                                <td><%= usos %></td>
                            <% end %>
                          </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
                </div>
                </div>
                <!-- tabela com quantos barris estão sujos, quantos barris estão limpos, quantos barris estão na câmara fria -->
                <div class="col-md-6 col-sm-6 col-xs-12">
            <div class="x_panel">
              <div class="x_title">
                <h2>Variação do estoque por mês</h2>
                <div class="clearfix"></div>
              </div>
                <div class="x_content" >
                  <table id="datatable-responsive2" class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0" width="100%">
                    <thead>
                      <tr>
                        <th>Id do item</th>
                        <th>Item</th>
                        <th>Localização do produto</th>
                        <th>Tempo no cliente, caso fora da fábrica</th>
                        <th>Tipo de cerveja, caso barril esteja na câmara fria</th>
                        <th>Data da última atualização</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @ciclovida.each do |ciclovida| %>
                        <% tempo_no_cliente = (Time.current.day - ciclovida.updated_at.day).to_i %>
                        
                          <tr>
                            <td><%= ciclovida.item.id %></td>
                            <td><%= ciclovida.item.item_name %></td>
                            <td><%= ciclovida.localizacao %></td>
                            <td><%= tempo_no_cliente.to_s + " dias" %></td>
                            <td><%= ciclovida.tipo_cerveja %></td>
                            <td><%= ciclovida.updated_at.to_date %></td>
                          </tr>
                        
                      <% end %>
                    </tbody>
                  </table>
                </div>
                </div>
                </div>
        </div>
        <div class="clearfix"></div> 
      </div>
    </div>

          
  </div>
</div>
<div class="clearfix"></div>

<div id="custom_notifications" class="custom-notifications dsp_none">
    <ul class="list-unstyled notifications clearfix" data-tabbed_notifications="notif-group">
    </ul>
    <div class="clearfix"></div>
    <div id="notif-group" class="tabbed_notifications"></div>
</div>

  <script>
    Chart.defaults.global.legend = {
      enabled: false
    };

    // Bar chart uso total de barris
    var ctx1 = document.getElementById("usostotalChart");
    var usostotalChart = new Chart(ctx1, {
      type: 'bar',

          
      data: {
         
      labels: <%= raw array_itens.to_json %>,
        datasets: [{
          label: 'Quantidade de usos total',
          backgroundColor: "#26B99A",
        <% data_array =[] %>
          <% array_itensid.each do |itensid| %>
            <% data = (@ciclovida.where(item_id: itensid).count - @ciclovida.where(item_id: itensid, localizacao: "Estoque final. Sujo e vazio").count - @ciclovida.where(item_id: itensid, localizacao: "Câmara fria. Cheio").count - @ciclovida.where(item_id: itensid, localizacao: "Estoque de barris. Limpo e vazio").count )%>
            <% data_array << data %> 
          <% end %>
          data: <%= data_array.select.to_json %>

        }]
      },

      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    });


  </script>
  

  
  
        